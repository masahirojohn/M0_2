name: PhaseA Yaw Check
on:
  workflow_dispatch: {}

jobs:
  yaw:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install deps (best-effort)
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install opencv-python-headless pillow pyyaml numpy || true

      - name: Convert V1 → flat (yaw)
        run: |
          python tests/phaseA_pose_only/tools/pose_v1_to_flat.py \
            tests/phaseA_pose_only/timelines/pose_timeline_yaw.json \
            tests/phaseA_pose_only/timelines/pose_timeline_yaw.flat.json

      - name: Run M0 (yaw only)
        run: |
          python m0_runner.py \
            --config configs/m0.yaml \
            --override tests/phaseA_pose_only/configs/phaseA_yaw.override.yaml

      - name: Verify outputs
        run: |
          test -f tests/out/exp_phaseA_yaw/run.log.json
          test -f tests/out/exp_phaseA_yaw/summary.csv
          # baseline混入を厳格チェック
          if [ -d out/exp_baseline ]; then
            echo "Found out/exp_baseline — FAIL"; exit 1; fi
          if grep -q '"exp_baseline"' tests/out/exp_phaseA_yaw/run.log.json; then
            echo "exp_baseline detected in run.log.json — FAIL"; exit 1; fi

      - name: Upload artifacts (mp4含む)  # ←コミットはしない
        uses: actions/upload-artifact@v4
        with:
          name: phaseA_yaw_outputs
          path: |
            tests/out/exp_phaseA_yaw/**
          if-no-files-found: error
